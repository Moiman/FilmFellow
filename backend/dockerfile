FROM alpine:3.19 AS builder
WORKDIR /app

RUN apk add --no-cache nodejs npm

COPY package*.json ./
COPY ./src ./src
COPY ./prisma ./prisma
COPY ./tsconfig*.json ./

RUN npm ci
RUN npm run build

FROM alpine:3.19 AS final
WORKDIR /app

COPY --from=builder /app/dist ./dist
COPY ./package*.json ./
COPY ./prisma ./prisma

ARG DATABASE_URL

ENV DATABASE_URL="postgresql://pguser:pgpass@localhost:5432/postgres?schema=public"

RUN apk add --no-cache nodejs npm
RUN npm ci --omit=dev

EXPOSE ${BACKEND_PORT}

CMD ["npm", "start"]